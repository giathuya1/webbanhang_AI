<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Chi tiết sản phẩm - TechShop</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<style>
:root {
  --primary: #667eea;
  --secondary: #764ba2;
}
body { background: #f8f9fa; }
.navbar-custom {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
}
.navbar-custom .navbar-brand, .navbar-custom .nav-link { color: #fff !important; }
.navbar-custom .nav-link:hover { color: #ddd !important; }

/* Breadcrumb */
.breadcrumb-item a { color: var(--primary); text-decoration: none; }
.breadcrumb-item a:hover { text-decoration: underline; }

/* Gallery */
.main-image {
  width: 100%;
  height: 400px;
  object-fit: contain;
  background: #fff;
  border-radius: 12px;
  border: 1px solid #eee;
}
.thumbnail-list {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  overflow-x: auto;
  padding-bottom: 10px;
}
.thumbnail-item {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
  flex-shrink: 0;
}
.thumbnail-item:hover { border-color: #aaa; }
.thumbnail-item.active { border-color: var(--primary); }

/* Product Info */
.product-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: #333;
}
.product-category {
  color: #6c757d;
  font-size: 14px;
}
.product-price {
  font-size: 2rem;
  font-weight: bold;
  color: #e74c3c;
}
.product-price-old {
  font-size: 1.2rem;
  color: #999;
  text-decoration: line-through;
  margin-left: 10px;
}
.discount-badge {
  background: #e74c3c;
  color: #fff;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 14px;
  margin-left: 10px;
}
.stock-status {
  font-size: 14px;
  padding: 5px 15px;
  border-radius: 20px;
}
.stock-in { background: #d4edda; color: #155724; }
.stock-out { background: #f8d7da; color: #721c24; }

/* Quantity */
.qty-selector {
  display: flex;
  align-items: center;
  gap: 5px;
}
.qty-btn {
  width: 40px;
  height: 40px;
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
}
.qty-btn:hover { background: #f0f0f0; }
.qty-input {
  width: 60px;
  height: 40px;
  text-align: center;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
}

/* Buttons */
.btn-cart {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  border: none;
  color: #fff;
  padding: 12px 30px;
  border-radius: 8px;
  font-weight: 600;
}
.btn-cart:hover {
  background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
  color: #fff;
}
.btn-buy {
  background: #e74c3c;
  border: none;
  color: #fff;
  padding: 12px 30px;
  border-radius: 8px;
  font-weight: 600;
}
.btn-buy:hover { background: #c0392b; color: #fff; }

/* Tabs */
.nav-tabs .nav-link {
  color: #666;
  font-weight: 500;
}
.nav-tabs .nav-link.active {
  color: var(--primary);
  border-bottom: 2px solid var(--primary);
}

/* Related Products */
.related-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #333;
  border-left: 4px solid var(--primary);
  padding-left: 15px;
}
.product-card {
  border: none;
  border-radius: 12px;
  overflow: hidden;
  transition: transform 0.3s, box-shadow 0.3s;
  height: 100%;
}
.product-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}
.product-card-img {
  height: 180px;
  object-fit: cover;
}
.product-card-name {
  font-weight: 600;
  color: #333;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  min-height: 48px;
}
.product-card-price {
  color: #e74c3c;
  font-weight: bold;
  font-size: 1.1rem;
}

/* Cart Badge */
.cart-badge {
  position: absolute;
  top: -5px;
  right: -10px;
  background: #e74c3c;
  color: #fff;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.cart-icon { position: relative; }

/* Features */
.feature-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 0;
  border-bottom: 1px solid #eee;
}
.feature-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
}

/* Loading */
.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 400px;
}
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-custom sticky-top">
  <div class="container">
    <a class="navbar-brand" href="products.html"><i class="fa fa-store me-2"></i>TechShop</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="#">Trang chủ</a></li>
        <li class="nav-item"><a class="nav-link" href="products.html">Sản phẩm</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Khuyến mãi</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Liên hệ</a></li>
      </ul>
      <div class="d-flex align-items-center">
        <a href="products.html" class="nav-link cart-icon">
          <i class="fa fa-shopping-cart fa-lg"></i>
          <span class="cart-badge" id="cartCount">0</span>
        </a>
      </div>
    </div>
  </div>
</nav>

<!-- MAIN CONTENT -->
<div class="container py-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="products.html">Trang chủ</a></li>
      <li class="breadcrumb-item"><a href="products.html">Sản phẩm</a></li>
      <li class="breadcrumb-item active" id="breadcrumbCategory">Danh mục</li>
    </ol>
  </nav>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Đang tải...</span>
    </div>
  </div>

  <!-- Product Detail -->
  <div id="productDetail" style="display:none;">
    <div class="row">
      <!-- Gallery -->
      <div class="col-lg-5 mb-4">
        <div class="card p-3">
          <img id="mainImage" src="" alt="" class="main-image">
          <div class="thumbnail-list" id="thumbnailList">
            <!-- Thumbnails loaded here -->
          </div>
        </div>
      </div>

      <!-- Info -->
      <div class="col-lg-7 mb-4">
        <div class="card p-4">
          <span class="product-category" id="productCategory"></span>
          <h1 class="product-title mt-2" id="productName"></h1>
          
          <div class="d-flex align-items-center mt-3">
            <span class="product-price" id="productPrice"></span>
            <span class="product-price-old" id="productOldPrice"></span>
            <span class="discount-badge" id="discountBadge" style="display:none;"></span>
          </div>

          <div class="mt-3">
            <span class="stock-status" id="stockStatus"></span>
          </div>

          <hr>

          <!-- Quantity -->
          <div class="d-flex align-items-center gap-4 mt-3">
            <span>Số lượng:</span>
            <div class="qty-selector">
              <button class="qty-btn" id="btnQtyMinus">-</button>
              <input type="number" class="qty-input" id="quantityInput" value="1" min="1">
              <button class="qty-btn" id="btnQtyPlus">+</button>
            </div>
            <span class="text-muted" id="stockAvailable"></span>
          </div>

          <!-- Buttons -->
          <div class="d-flex gap-3 mt-4">
            <button class="btn btn-cart" id="btnAddCart">
              <i class="fa fa-cart-plus me-2"></i>Thêm vào giỏ hàng
            </button>
            <button class="btn btn-buy" id="btnBuyNow">
              <i class="fa fa-bolt me-2"></i>Mua ngay
            </button>
          </div>

          <hr>

          <!-- Features -->
          <div class="feature-item">
            <div class="feature-icon"><i class="fa fa-truck"></i></div>
            <div>
              <strong>Miễn phí vận chuyển</strong>
              <p class="mb-0 text-muted small">Cho đơn hàng từ 500.000đ</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon"><i class="fa fa-shield-alt"></i></div>
            <div>
              <strong>Bảo hành chính hãng</strong>
              <p class="mb-0 text-muted small">12 tháng bảo hành toàn quốc</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon"><i class="fa fa-sync"></i></div>
            <div>
              <strong>Đổi trả dễ dàng</strong>
              <p class="mb-0 text-muted small">7 ngày đổi trả miễn phí</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs: Description -->
    <div class="card mt-4">
      <div class="card-body">
        <ul class="nav nav-tabs" id="productTabs">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#tabDescription">Mô tả sản phẩm</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tabSpecs">Thông số kỹ thuật</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tabReviews">Đánh giá</a>
          </li>
        </ul>
        <div class="tab-content p-4">
          <div class="tab-pane fade show active" id="tabDescription">
            <p id="productDescription">Đang cập nhật mô tả sản phẩm...</p>
          </div>
          <div class="tab-pane fade" id="tabSpecs">
            <table class="table table-bordered">
              <tbody id="productSpecs">
                <tr><td>Thương hiệu</td><td id="specBrand">-</td></tr>
                <tr><td>Danh mục</td><td id="specCategory">-</td></tr>
                <tr><td>Tình trạng</td><td id="specStock">-</td></tr>
              </tbody>
            </table>
          </div>
          <div class="tab-pane fade" id="tabReviews">
            <p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products -->
    <div class="mt-5">
      <h4 class="related-title mb-4">Sản phẩm tương tự</h4>
      <div class="row g-4" id="relatedProducts">
        <!-- Related products loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="bg-dark text-white py-4 mt-5">
  <div class="container text-center">
    <p class="mb-0">&copy; 2026 TechShop. All rights reserved.</p>
  </div>
</footer>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_URL = 'api';

// State
let product = null;
let cart = JSON.parse(localStorage.getItem('cart')) || [];

// Get product ID from URL
function getProductId() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

// Format price
function formatPrice(price) {
  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
}

// Load Product Detail
function loadProductDetail() {
  const productId = getProductId();
  if (!productId) {
    window.location.href = 'products.html';
    return;
  }

  $.get(`${API_URL}/products.php?id=${productId}`, function(res) {
    if (res.success && res.data) {
      product = res.data;
      renderProductDetail();
      loadRelatedProducts();
      $('#loading').hide();
      $('#productDetail').show();
    } else {
      alert('Không tìm thấy sản phẩm!');
      window.location.href = 'products.html';
    }
  }).fail(function() {
    alert('Lỗi khi tải sản phẩm!');
    window.location.href = 'products.html';
  });
}

// Render Product Detail
function renderProductDetail() {
  // Title
  document.title = product.name + ' - TechShop';
  
  // Breadcrumb
  $('#breadcrumbCategory').text(product.category_name || 'Sản phẩm');
  
  // Basic Info
  $('#productName').text(product.name);
  $('#productCategory').html(`<i class="fa fa-tag me-1"></i>${product.category_name || 'Chưa phân loại'}`);
  $('#productPrice').text(formatPrice(product.price));
  
  // Stock
  if (product.stock > 0) {
    $('#stockStatus').removeClass('stock-out').addClass('stock-in').html('<i class="fa fa-check-circle me-1"></i>Còn hàng');
    $('#stockAvailable').text(`(${product.stock} sản phẩm có sẵn)`);
    $('#quantityInput').attr('max', product.stock);
    $('#btnAddCart, #btnBuyNow').prop('disabled', false);
  } else {
    $('#stockStatus').removeClass('stock-in').addClass('stock-out').html('<i class="fa fa-times-circle me-1"></i>Hết hàng');
    $('#stockAvailable').text('');
    $('#btnAddCart, #btnBuyNow').prop('disabled', true);
  }
  
  // Images
  if (product.images && product.images.length > 0) {
    $('#mainImage').attr('src', product.images[0].image_url);
    
    let thumbHtml = '';
    product.images.forEach((img, idx) => {
      thumbHtml += `<img src="${img.image_url}" class="thumbnail-item ${idx === 0 ? 'active' : ''}" onclick="changeImage(this, '${img.image_url}')">`;
    });
    $('#thumbnailList').html(thumbHtml);
  } else {
    $('#mainImage').attr('src', 'https://via.placeholder.com/400x400?text=No+Image');
    $('#thumbnailList').html('');
  }
  
  // Specs
  $('#specCategory').text(product.category_name || '-');
  $('#specStock').text(product.stock > 0 ? 'Còn hàng' : 'Hết hàng');
  
  // Description
  $('#productDescription').html(`
    <h5>${product.name}</h5>
    <p>Sản phẩm ${product.name} thuộc danh mục ${product.category_name || 'chưa phân loại'}.</p>
    <p>Giá bán: <strong>${formatPrice(product.price)}</strong></p>
    <p>Số lượng trong kho: <strong>${product.stock}</strong> sản phẩm.</p>
    <hr>
    <h6>Đặc điểm nổi bật:</h6>
    <ul>
      <li>Sản phẩm chính hãng 100%</li>
      <li>Bảo hành 12 tháng toàn quốc</li>
      <li>Hỗ trợ đổi trả trong 7 ngày</li>
      <li>Giao hàng nhanh chóng</li>
    </ul>
  `);
}

// Change main image
function changeImage(el, src) {
  $('#mainImage').attr('src', src);
  $('.thumbnail-item').removeClass('active');
  $(el).addClass('active');
}

// Load Related Products
function loadRelatedProducts() {
  const categoryId = product.category_id;
  
  $.get(`${API_URL}/products.php?category_id=${categoryId}&limit=4`, function(res) {
    if (res.success) {
      // Filter out current product
      const related = res.data.filter(p => p.id != product.id).slice(0, 4);
      
      if (related.length === 0) {
        $('#relatedProducts').html('<p class="text-muted">Không có sản phẩm tương tự.</p>');
        return;
      }
      
      let html = '';
      related.forEach(p => {
        const imgSrc = p.image || 'https://via.placeholder.com/200x180?text=No+Image';
        html += `
          <div class="col-md-6 col-lg-3">
            <div class="card product-card">
              <a href="product-detail.html?id=${p.id}">
                <img src="${imgSrc}" class="card-img-top product-card-img" alt="${p.name}">
              </a>
              <div class="card-body">
                <p class="text-muted small mb-1">${p.category_name || ''}</p>
                <h6 class="product-card-name">
                  <a href="product-detail.html?id=${p.id}" class="text-decoration-none text-dark">${p.name}</a>
                </h6>
                <p class="product-card-price mb-2">${formatPrice(p.price)}</p>
                <button class="btn btn-sm btn-outline-primary w-100" onclick="quickAddCart(${p.id}, '${p.name.replace(/'/g, "\\'")}', ${p.price}, '${imgSrc}')">
                  <i class="fa fa-cart-plus me-1"></i>Thêm giỏ
                </button>
              </div>
            </div>
          </div>
        `;
      });
      $('#relatedProducts').html(html);
    }
  });
}

// Cart Functions
function addToCart() {
  if (!product || product.stock <= 0) return;
  
  const qty = parseInt($('#quantityInput').val()) || 1;
  
  const existingItem = cart.find(item => item.id == product.id);
  if (existingItem) {
    existingItem.quantity += qty;
  } else {
    cart.push({
      id: product.id,
      name: product.name,
      price: product.price,
      image: product.images && product.images[0] ? product.images[0].image_url : '',
      quantity: qty
    });
  }
  
  saveCart();
  updateCartCount();
  showToast(`Đã thêm "${product.name}" vào giỏ hàng!`);
}

function quickAddCart(id, name, price, image) {
  const existingItem = cart.find(item => item.id == id);
  if (existingItem) {
    existingItem.quantity += 1;
  } else {
    cart.push({ id, name, price, image, quantity: 1 });
  }
  saveCart();
  updateCartCount();
  showToast(`Đã thêm "${name}" vào giỏ hàng!`);
}

function saveCart() {
  localStorage.setItem('cart', JSON.stringify(cart));
}

function updateCartCount() {
  const count = cart.reduce((sum, item) => sum + item.quantity, 0);
  $('#cartCount').text(count);
}

function showToast(message) {
  const toast = $(`<div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999;">
    <div class="toast show bg-success text-white">
      <div class="toast-body"><i class="fa fa-check-circle me-2"></i>${message}</div>
    </div>
  </div>`);
  $('body').append(toast);
  setTimeout(() => toast.remove(), 2000);
}

// Event Handlers
$('#btnQtyMinus').on('click', function() {
  let val = parseInt($('#quantityInput').val());
  if (val > 1) $('#quantityInput').val(val - 1);
});

$('#btnQtyPlus').on('click', function() {
  let val = parseInt($('#quantityInput').val());
  let max = product ? product.stock : 99;
  if (val < max) $('#quantityInput').val(val + 1);
});

$('#btnAddCart').on('click', addToCart);

$('#btnBuyNow').on('click', function() {
  addToCart();
  window.location.href = 'products.html'; // Redirect to cart/checkout
});

// Init
$(document).ready(function() {
  updateCartCount();
  loadProductDetail();
});
</script>

</body>
</html>
