<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý người dùng & phân quyền</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<style>
body { background: #f4f6f9; }
.header-title {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px 20px;
  border-radius: 8px 8px 0 0;
}
.card { border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.table thead { background: #343a40; color: white; }
.badge-active { background: #28a745; }
.badge-inactive { background: #dc3545; }
.btn-edit { background: #ffc107; border: none; color: #000; }
.btn-edit:hover { background: #e0a800; color: #000; }
.btn-delete { background: #dc3545; border: none; color: #fff; }
.btn-delete:hover { background: #c82333; color: #fff; }
.pagination .page-link { color: #333; }
.pagination .page-item.active .page-link { background: #007bff; border-color: #007bff; color: #fff; }
.search-input { border-radius: 20px; padding-left: 35px; }
.search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; }
</style>
</head>
<body>

<div class="container py-4">
  <div class="card">
    <!-- Header -->
    <div class="header-title">
      <h5 class="mb-0"><i class="fa fa-users me-2"></i>Quản lý người dùng & phân quyền</h5>
    </div>
    
    <div class="card-body">
      <!-- Toolbar -->
      <div class="row mb-3">
        <div class="col-md-6">
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#userModal" id="btnAddUser">
            <i class="fa fa-plus me-1"></i>Thêm người dùng
          </button>
        </div>
        <div class="col-md-6">
          <div class="position-relative">
            <i class="fa fa-search search-icon"></i>
            <input type="text" class="form-control search-input" id="searchUser" placeholder="Tìm kiếm người dùng">
          </div>
        </div>
      </div>
      
      <!-- Table -->
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Username</th>
            <th>Họ tên</th>
            <th>Quyền</th>
            <th>Trạng thái</th>
            <th width="120">Chức năng</th>
          </tr>
        </thead>
        <tbody id="userTable">
          <tr><td colspan="5" class="text-center">Đang tải...</td></tr>
        </tbody>
      </table>
      
      <!-- Pagination -->
      <nav>
        <ul class="pagination justify-content-start" id="pagination"></ul>
      </nav>
    </div>
  </div>
</div>

<!-- USER MODAL -->
<div class="modal fade" id="userModal">
<div class="modal-dialog">
<form class="modal-content" id="userForm">
  <div class="modal-header bg-primary text-white">
    <h5 class="modal-title">Thêm người dùng</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="userId">
    <div class="mb-3">
      <label class="form-label">Username <span class="text-danger">*</span></label>
      <input type="text" class="form-control" id="username" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Họ tên</label>
      <input type="text" class="form-control" id="fullname">
    </div>
    <div class="mb-3">
      <label class="form-label">Password <span class="text-danger">*</span></label>
      <input type="password" class="form-control" id="password" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Quyền</label>
      <select class="form-select" id="roleSelect"></select>
    </div>
    <div class="mb-3">
      <label class="form-label">Trạng thái</label>
      <select class="form-select" id="statusSelect">
        <option value="1">Hoạt động</option>
        <option value="0">Không hoạt động</option>
      </select>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
    <button type="submit" class="btn btn-primary">Lưu</button>
  </div>
</form>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_URL = 'api';

// State
let roles = [];
let users = [];
let currentPage = 1;
let totalPages = 1;
const limit = 5; // Số dòng mỗi trang

// Load Roles
function loadRoles() {
  $.get(`${API_URL}/roles.php`, function(res) {
    if (res.success) {
      roles = res.data;
      let html = '';
      roles.forEach(r => html += `<option value="${r.id}">${r.name}</option>`);
      $('#roleSelect').html(html);
    }
  });
}

// Load Users với phân trang
function loadUsers() {
  const search = $('#searchUser').val().trim();
  
  const params = new URLSearchParams({
    page: currentPage,
    limit: limit,
    search: search
  });
  
  $.get(`${API_URL}/user_search_pagging.php?${params}`, function(res) {
    if (res.success) {
      users = res.data;
      totalPages = res.pagination.total_pages;
      renderTable();
      renderPagination();
    }
  });
}

// Render Table
function renderTable() {
  if (users.length === 0) {
    $('#userTable').html('<tr><td colspan="5" class="text-center text-muted">Không tìm thấy người dùng nào</td></tr>');
    return;
  }
  
  let html = '';
  users.forEach(user => {
    const roleName = user.role_name || getRoleName(user.role_id);
    const statusBadge = user.status == 1 
      ? '<span class="badge badge-active">Hoạt động</span>'
      : '<span class="badge badge-inactive">Không hoạt động</span>';
    
    html += `
      <tr>
        <td>${user.username}</td>
        <td>${user.fullname || ''}</td>
        <td>${capitalizeFirst(roleName)}</td>
        <td>${statusBadge}</td>
        <td>
          <button class="btn btn-sm btn-edit btn-edit-user" data-id="${user.id}">Sửa</button>
          <button class="btn btn-sm btn-delete btn-delete-user" data-id="${user.id}">Xóa</button>
        </td>
      </tr>
    `;
  });
  $('#userTable').html(html);
}

// Render Pagination
function renderPagination() {
  if (totalPages <= 1) {
    $('#pagination').html('');
    return;
  }
  
  let html = '';
  
  // Nút «
  html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
    <a class="page-link" href="#" data-page="${currentPage - 1}">«</a>
  </li>`;
  
  // Các số trang
  for (let i = 1; i <= totalPages; i++) {
    html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
      <a class="page-link" href="#" data-page="${i}">${i}</a>
    </li>`;
  }
  
  // Nút »
  html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
    <a class="page-link" href="#" data-page="${currentPage + 1}">»</a>
  </li>`;
  
  $('#pagination').html(html);
}

// Helper functions
function getRoleName(roleId) {
  const role = roles.find(r => r.id == roleId);
  return role ? role.name : 'Unknown';
}

function capitalizeFirst(str) {
  return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
}

// Event: Click phân trang
$(document).on('click', '#pagination .page-link', function(e) {
  e.preventDefault();
  const page = $(this).data('page');
  if (page >= 1 && page <= totalPages && page !== currentPage) {
    currentPage = page;
    loadUsers();
  }
});

// Event: Tìm kiếm
$('#searchUser').on('keyup', function(e) {
  if (e.key === 'Enter') {
    currentPage = 1;
    loadUsers();
  }
});

// Event: Thêm/Sửa User
$('#userForm').on('submit', function(e) {
  e.preventDefault();
  
  const id = $('#userId').val();
  const data = {
    username: $('#username').val().trim(),
    fullname: $('#fullname').val().trim(),
    role_id: parseInt($('#roleSelect').val()),
    status: parseInt($('#statusSelect').val())
  };
  
  if (id) {
    data.id = parseInt(id);
    const password = $('#password').val();
    if (password) data.password = password;
    
    $.ajax({
      url: `${API_URL}/users.php`,
      method: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function(res) {
        if (res.success) {
          alert('Cập nhật thành công!');
          $('#userModal').modal('hide');
          loadUsers();
        } else {
          alert(res.message);
        }
      }
    });
  } else {
    data.password = $('#password').val();
    
    $.ajax({
      url: `${API_URL}/users.php`,
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function(res) {
        if (res.success) {
          alert('Thêm người dùng thành công!');
          $('#userModal').modal('hide');
          loadUsers();
        } else {
          alert(res.message);
        }
      }
    });
  }
});

// Event: Mở modal Edit
$(document).on('click', '.btn-edit-user', function() {
  const id = $(this).data('id');
  const user = users.find(u => u.id == id);
  
  if (user) {
    $('#userId').val(user.id);
    $('#username').val(user.username);
    $('#fullname').val(user.fullname || '');
    $('#password').val('').removeAttr('required');
    $('#roleSelect').val(user.role_id);
    $('#statusSelect').val(user.status);
    $('.modal-title').text('Sửa người dùng');
    $('#userModal').modal('show');
  }
});

// Event: Xóa User
$(document).on('click', '.btn-delete-user', function() {
  if (confirm('Bạn có chắc muốn xóa người dùng này?')) {
    const id = $(this).data('id');
    
    $.ajax({
      url: `${API_URL}/users.php?id=${id}`,
      method: 'DELETE',
      success: function(res) {
        if (res.success) {
          alert('Xóa thành công!');
          loadUsers();
        } else {
          alert(res.message || 'Không thể xóa');
        }
      }
    });
  }
});

// Event: Reset modal khi mở Add
$('#btnAddUser').on('click', function() {
  $('#userForm')[0].reset();
  $('#userId').val('');
  $('#password').attr('required', true);
  $('.modal-title').text('Thêm người dùng');
});

// Init
$(document).ready(function() {
  loadRoles();
  loadUsers();
});
</script>

</body>
</html>